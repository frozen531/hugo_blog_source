---
title: "流媒体传输协议:RTP"
date: 2023-03-21T20:22:59+08:00
draft: true
tags: ["流媒体"]
categories: ["音视频"]
---

## 简介

RTP(real-time transport protocol实时传输协议)，传输具有实时特性的数据，为实时数据（音频、视频）提供端到端的传输服务。如果底层网络可支持多路分发，RTP可以将数据传输给多个目标。

RTCP(RTP控制协议)，监控QoS和传递会话中参与者的信息，它没有明确的成员控制功能和session建立过程。当进行RTP传输时，会周期性反馈接收者的名字和数据接收情况等信息，当有接收者数据接收不正常时，可能会相应的改变编码、控制带宽限制等。

在不同的组播地址和端口对中，音频和视频可以不在同一个RTP session发送，分别传输各自的RTP报文和RTCP报文，接收者可以建立同名的session，通过参考RTCP协议中时间信息来同步播放。

### 可靠性

一般应用都是基于UDP协议。RTP不提供任何机制保证数据的实时性和QoS（Quality of Service，服务质量：指一个网络能够利用各种基础技术，为指定的网络通信提供更好的服务能力，是网络的一种安全机制， 是用来解决网络延迟和阻塞等问题的一种技术），而是依赖底层网络服务提供这些功能。

RTP既不保证传输的可靠性和有序性，也不假定底层网络是否可信和有序。接收端可以利用RTP中的序列号排序收到的报文。

### 携带信息

RTP包包含了时间信息、序列号、荷载类型、时间戳等。接收者可以通过相关信息重新排列数据包，同时可以知道丢失了多少报文。

### RTP级别的中继节点Mixer

不同的接收者网络情况不同，不能强迫所有接收者都使用低带宽并降低音频编码的质量。

多媒体应用可以根据接收者的能力或网络拥堵情况调整传输速率，降低分辨率，降低码率，减小网络压力。但这个操作放在发送端和组播模式（多人会议）不太兼容，因为这样会产生木桶效应，带宽最差的接收者会拖垮这个会议的通讯质量。<font color=red>不清楚Mixer是否是将高码率的流重新压缩，产生多种不同码率的流，这个有点难度吧，费时？</font>

带宽自适应的工作应该放在接收者这里，发送者需要拆分出面对不同带宽接收者的媒体流（不同的码率，500k，2M，5M，<font color=red>主码流和子码流是否就是对这种的适应？</font>），分别对应不同的组播地址，接收者根据自身带宽情况，选中加入适合的组播。

## RTP 数据传输协议

![RTP的定长头字段](RTP的定长头字段.bmp)

96-bit（12Byte）为每个RTP包都有的部分。CSRC部分只有Mixer发送的报文才会有。RTP报文由两部分构成：RTP报头和RTP负载。

位 | 说明
---|---
V | RTP协议的版本号，占2位，当前协议版本号为2。
P | 填充标志，占1位，如果P=1，则在该报文的尾部填充一个或多个额外的八位组，它们不是有效载荷的一部分。
X | 扩展标志，占1位，如果X=1，则在RTP报头后跟有一个扩展报头。
CC | CSRC计数器，占4位，指示CSRC 标识符的个数。
M | 标记，占1位，不同的有效载荷有不同的含义，对于视频，标记一帧的结束；对于音频，标记会话的开始。
PT | 有效载荷类型，占7位，用于说明RTP报文中有效载荷的类型，如GSM音频、JPEM图像等,在流媒体中大部分是用来区分音频流和视频流的，这样便于客户端进行解析。
序列号 | 占16位，用于标识发送者所发送的RTP报文的序列号，每发送一个报文，序列号增1。这个字段当下层的承载协议用UDP的时候，网络状况不好的时候可以用来检查丢包。同时出现网络抖动的情况可以用来对数据进行重新排序，在helix服务器中这个字段是从0开始的，同时音频包和视频包的sequence是分别记数的。
时戳(Timestamp) | 占32位，时戳反映了该RTP报文的第一个八位组的采样时刻。接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。
同步信源(SSRC)标识符 | 占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。
特约信源(CSRC)标识符 | 每个CSRC标识符占32位，可以有0～15个。每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源。

### RTP扩展头结构

在固定头中有扩展头标志位，标志位置1可以在固定头之后可以加一个扩展头。

### RTCP的封装

主要是对服务质量的监视和反馈，媒体间的同步，以及多播组中成员的标识。

RTCP包含有已发送的数据包的数据、丢失数据包的数量统计。可以通过监视网络情况，将用户加入不同的组播中，满足用户的流畅度和实时性。

## RTP会话过程

应用程序建立一个RTP会话，应用程序确定目的传输地址（网络地址IP和端口地址，两个端口：RTP包和RTCP包）。



## 链接
1. [流媒体传输协议之 RTP （上篇）](https://blog.csdn.net/irainsa/article/details/128000807)
2. [RTP/RTCP详解系列-----协议介绍](https://cloud.tencent.com/developer/article/2020373)